<!DOCTYPE html>
<html>
<head>
    <meta charset="utf-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>{$title}</title>
    <link rel="shortcut icon" href="/favicon.ico">
    <link href="/Public/client/static/bootstrap/3.3.6/css/bootstrap.min.css" rel="stylesheet">
    <link href="/Public/client/static/font-awesome/4.7.0/css/font-awesome.min.css" rel="stylesheet">

    <link href="/Public/client/static/bootstrap/3.3.6/css/bootstrap.min.css" rel="stylesheet">
    <link href="/Public/client/static/bootstrap-table/1.11.1/bootstrap-table.min.css" rel="stylesheet">
    <link href="/Public/client/hplus/css/plugins/dataTables/dataTables.bootstrap.css" rel="stylesheet">

    <link href="/Public/client/static/animate.css/3.5.2/animate.min.css" rel="stylesheet">
    <link href="/Public/client/hplus/css/style.min862f.css?v=4.1.0" rel="stylesheet">
    <link href="/Public/client/hplus/css/plugins/sweetalert/sweetalert.css" rel="stylesheet">

    <link href="/Public/client/static/finance/css/fm.selectator.jquery.css" rel="stylesheet">
    <link href="/Public/client/hplus/css/plugins/iCheck/custom.css" rel="stylesheet">

</head>

<body class="gray-bg">
<div class="wrapper wrapper-content animated fadeInRight">
    <div class="row">
        <div class="col-sm-12">
            <div class="ibox float-e-margins">
                <div class="ibox-title">
                    <h5>{$title}</h5>

                    <div class="ibox-tools">
                        <a class="collapse-link">
                            <i class="fa fa-chevron-up"></i>
                        </a>
                        <a class="close-link">
                            <i class="fa fa-times"></i>
                        </a>
                    </div>
                </div>
                <div class="ibox-content">
                    <div id="table-bar"></div>
                    <table id="example"></table>
                </div>

            </div>
        </div>
    </div>
</div>

<div class="modal inmodal fade" id="orderDetailModal" tabindex="-1" role="dialog" aria-hidden="true">
    <div class="modal-dialog modal-lg">
        <div class="modal-content">
            <div class="modal-header">
                <button type="button" class="close" data-dismiss="modal"><span aria-hidden="true">&times;</span><span class="sr-only">Close</span>
                </button>
                <h4 class="modal-title">订单详情</h4>
                <small class="font-bold"></small>
            </div>
            <div class="modal-body">
            <div class="row">
                <div class="col-sm-12">
                    <div class="ibox-content p-xl">
                        <div class="row">
                            <div class="col-sm-6">
                                <h4>订单编号：</h4>
                                <h4 class="text-navy">{{orderInfo.order_num}}</h4>
                                <address>
                                    渠道类型：{{orderInfo.channel_name}} / {{orderInfo.channel_en_name}}<br />
                                    价格条款：{{orderInfo.price_terms}}<br />
                                    装运参考：{{orderInfo.shipment_reference}}<br />
                                    相关委托书：{{orderInfo.declaration_of_power_attorney}}<br />
                                    出口原因：{{orderInfo.export_reason}}<br />
                                    运输方式：{{orderInfo.mode_of_transportation}}&nbsp;{{orderInfo.express_service}}<br />
                                    制造商或出口商及地址：{{orderInfo.manufacturer}}<br />
                                </address>
                            </div>
                            <div class="col-sm-6">
                                <h4>订单状态：</h4>
                                <h4 class="text-navy">{{orderInfo.status_str}}</h4>
                                <address>
                                    寄件类型：{{packageTypeFormatter(orderInfo.package_type)}}<br />
                                    关税支付：{{orderInfo.tariff_payment}}<br />
                                    结汇方式：{{orderInfo.settlement}}<br />
                                    合同号：{{orderInfo.contract_num}}<br />
                                    出口原因：{{orderInfo.export_nature}}<br />
                                </address>
                            </div>
                        </div>



                        <div class="hr-line-dashed"></div>

                        <div class="row">
                            <div class="col-sm-12">
                                <h5>发货信息</h5>
                                <address>
                                    发货公司：<strong>{{orderInfo.delivery_company}}</strong><br />
                                    发货地址：{{orderInfo.delivery_detail_address}}<br />
                                    邮编：{{orderInfo.delivery_postal_code}}<br />
                                    发货人：{{orderInfo.delivery_consignor}}<br />
                                    手机：{{orderInfo.delivery_mobile}}<br />
                                    座机：{{orderInfo.delivery_phone}}<br />
                                    出口商代码：{{orderInfo.exporter_code}}<br />
                                </address>
                            </div>
                        </div>
                        <div class="hr-line-dashed"></div>

                        <div class="row">
                            <div v-bind:class="{ 'col-sm-6': orderInfo.enable_spare, 'col-sm-12': !orderInfo.enable_spare }">
                                <h5>收货信息</h5>
                                <address>
                                    收货公司：<strong>{{orderInfo.receive_company}}</strong><br />
                                    收货地址：{{orderInfo.receive_detail_address}}<br />
                                    邮编：{{orderInfo.receive_postal_code}}<br />
                                    收货人：{{orderInfo.receive_addressee}}<br />
                                    手机：{{orderInfo.receive_mobile}}<br />
                                    座机：{{orderInfo.receive_phone}}<br />
                                    进口商代码：{{orderInfo.receiver_code}}<br />
                                </address>
                            </div>
                            <div class="col-sm-6" v-show="orderInfo.enable_spare">
                                <h5>备用收货信息</h5>
                                <address>
                                    收货公司：<strong>{{orderInfo.spare_company}}</strong><br />
                                    收货地址：{{orderInfo.spare_detail_address}}<br />
                                    邮编：{{orderInfo.spare_postal_code}}<br />
                                    收货人：{{orderInfo.spare_addressee}}<br />
                                    手机：{{orderInfo.spare_mobile}}<br />
                                    座机：{{orderInfo.spare_phone}}<br />
                                    进口商代码：{{orderInfo.spare_receiver_code}}<br />
                                </address>
                            </div>
                        </div>


                        <div class="hr-line-dashed"></div>

                        <div class="table-responsive m-t">
                            <table class="table invoice-table">
                                <thead>
                                <tr>
                                    <th class="text-center">编号</th>
                                    <th class="text-center">品名</th>
                                    <th class="text-center">商品编码</th>
                                    <th class="text-center">单件申报价值</th>
                                    <th class="text-center">数量</th>
                                    <th class="text-center">总申报价值</th>
                                    <th class="text-center">原产地</th>
                                    <th class="text-center">材质</th>
                                </tr>
                                </thead>
                                <tbody>
                                <template v-for="(product,index) in productList">
                                <tr>
                                    <td class="text-center">{{index + 1}}</td>
                                    <td class="text-center">
                                        <div><strong>{{product.product_name}}</strong><br /><strong>{{product.en_product_name}}</strong></div>
                                    </td>
                                    <td class="text-center">{{product.goods_code}}</td>
                                    <td class="text-center">{{product.single_declared}}</td>
                                    <td class="text-center">{{product.count}}</td>
                                    <td class="text-center">{{product.total_declared}}</td>
                                    <td class="text-center">{{product.origin}}</td>
                                    <td class="text-center">{{product.texture}}</td>
                                </tr>
                                </template>
                                </tbody>
                            </table>
                        </div>

                        <div class="hr-line-dashed"></div>

                        <div class="table-responsive m-t">
                            <table class="table invoice-table">
                                <thead>
                                <tr>
                                    <th class="text-center">编号</th>
                                    <th class="text-center">品名</th>
                                    <th class="text-center">商品编码</th>
                                    <th class="text-center">数量</th>
                                    <th class="text-center">重量</th>
                                    <th class="text-center">长 宽 高</th>
                                    <th class="text-center">材积重</th>
                                    <th class="text-center">箱数</th>
                                </tr>
                                </thead>
                                <tbody>
                                <template v-for="(spec,index) in specificationList">
                                    <tr>
                                        <td class="text-center" :rowspan="spec.productList.length">{{indexFormatter(index)}}</td>
                                        <td class="text-center">{{spec.productList[0].product_name}}</td>
                                        <td class="text-center">{{spec.productList[0].goods_code}}</td>
                                        <td class="text-center">{{spec.productList[0].number}}</td>
                                        <td class="text-center" :rowspan="spec.productList.length" v-show="orderInfo.express_status == 0">{{spec.weight}}</td>
                                        <td class="text-center" :rowspan="spec.productList.length" v-show="orderInfo.express_status == 0">{{spec.length}} {{spec.width}} {{spec.height}}</td>
                                        <td class="text-center" :rowspan="spec.productList.length" v-show="orderInfo.express_status == 0">{{volumeWeight(spec.length,spec.width,spec.height)}}</td>
                                        <td class="text-center" :rowspan="spec.productList.length" v-show="orderInfo.express_status == 0">{{spec.count}}</td>
                                        <td class="text-center" :rowspan="spec.productList.length" v-show="orderInfo.express_status == 1"><del>{{spec.weight}}</del><br />{{spec.real_weight}}</td>
                                        <td class="text-center" :rowspan="spec.productList.length" v-show="orderInfo.express_status == 1"><del>{{spec.length}} {{spec.width}} {{spec.height}}</del><br />{{spec.real_length}} {{spec.real_width}} {{spec.real_height}}</td>
                                        <td class="text-center" :rowspan="spec.productList.length"v-show="orderInfo.express_status == 1"><del>{{volumeWeight(spec.length,spec.width,spec.height)}}</del><br />{{volumeWeight(spec.real_length,spec.real_width,spec.real_height)}}</td>
                                        <td class="text-center" :rowspan="spec.productList.length" v-show="orderInfo.express_status == 1"><del>{{spec.count}}</del><br />{{spec.real_count}}</td>
                                    </tr>
                                    <template v-for="(p,i) in spec.productList">
                                        <tr v-if="i > 0">
                                            <td class="text-center">{{spec.productList[i].product_name}}</td>
                                            <td class="text-center">{{spec.productList[i].goods_code}}</td>
                                            <td class="text-center">{{spec.productList[i].number}}</td>
                                        </tr>
                                    </template>
                                </template>
                                </template>
                                </tbody>
                            </table>
                        </div>
                        <!-- /table-responsive -->

                        <table class="table invoice-total" v-show="billingWeight">
                            <tbody>
                            <tr>
                                <td><strong>计费重量：</strong>
                                </td>
                                <td>{{billingWeight}}</td>
                            </tr>
                            </tbody>
                        </table>
                        <div class="well m-t" v-show="orderInfo.remark">
                            <strong>备注：</strong> {{orderInfo.remark}}
                        </div>
                        <div class="well m-t" v-show="orderInfo.specifications_remark">
                            <strong>托运备注：</strong> {{orderInfo.specifications_remark}}
                        </div>

                        <div class="hr-line-dashed"></div>

                        <div class="row" v-show="orderFee">
                            <div v-bind:class="{ 'col-sm-4': orderFee.length > 2, 'col-sm-6': orderFee.length > 1 && orderFee.length <= 2, 'col-sm-12': orderFee.length == 1 }" v-show="orderFee.length > 0">
                                <table class="table invoice-total" v-show="orderFee">
                                    <tbody>
                                    <template v-for="(item,index) in orderFee" >
                                    <tr v-show="(index % 3) == 0">
                                        <td><strong>{{item.label}}：</strong>
                                        </td>
                                        <td>{{moneyFormatter(item.value)}}</td>
                                    </tr>
                                    </template>
                                    </tbody>
                                </table>
                            </div>
                            <div v-bind:class="{ 'col-sm-4': orderFee.length > 2, 'col-sm-6': orderFee.length > 1 && orderFee.length <= 2 }" v-show="orderFee.length > 1">
                                <table class="table invoice-total" v-show="orderFee">
                                    <tbody>
                                    <template v-for="(item,index) in orderFee" >
                                        <tr v-show="(index % 3) == 1">
                                            <td><strong>{{item.label}}：</strong>
                                            </td>
                                            <td>{{moneyFormatter(item.value)}}</td>
                                        </tr>
                                    </template>
                                    </tbody>
                                </table>
                            </div>
                            <div class="col-sm-4" v-show="orderFee.length > 2">
                                <table class="table invoice-total" v-show="orderFee">
                                    <tbody>
                                    <template v-for="(item,index) in orderFee" >
                                        <tr v-show="(index % 3) == 2">
                                            <td><strong>{{item.label}}：</strong>
                                            </td>
                                            <td>{{moneyFormatter(item.value)}}</td>
                                        </tr>
                                    </template>
                                    </tbody>
                                </table>
                            </div>
                            <div class="col-sm-12">
                                <table class="table invoice-total" v-show="orderFee.length > 0">
                                    <tbody>
                                    <tr>
                                        <td><strong>总费用：</strong>
                                        </td>
                                        <td>{{moneyFormatter(totalFee)}}</td>
                                    </tr>
                                    <tr>
                                        <td><strong>结算方式：</strong>
                                        </td>
                                        <td>{{settlementMethod}}</td>
                                    </tr>
                                    <tr>
                                        <td><strong>签名：</strong>
                                        </td>
                                        <td v-show="1 == orderInfo.exam_status && 0 == orderInfo.ensure_status">
                                            <input type="text" class="" id="signature" name="signature" v-model="signature">
                                        </td>
                                        <td v-show="1 == orderInfo.exam_status && 1 == orderInfo.ensure_status">
                                            {{orderInfo.autograph}}
                                        </td>
                                    </tr>
                                    </tbody>
                                </table>
                            </div>
                        </div>
                        <div class="form-group" v-show="1 == orderInfo.exam_status && 0 == orderInfo.ensure_status">
                            <div class="col-sm-8 col-sm-offset-3">
                                <div class="checkbox">
                                    <label>
                                        <input type="checkbox" class="i-checks checkbox" id="agree" name="agree">
                                        我已经认真阅读并同意<a href="javascript:void(0)" onclick="show_agreement()">《华度运输协议》</a>
                                    </label>
                                </div>
                            </div>
                        </div>

                        <div class="text-right" v-show="0 == orderInfo.client_status">
                            <button class="btn btn-primary" @click="commitOrder(orderInfo.id)"></i> 提交</button>
                        </div>
                        <div class="text-right" v-show="1 == orderInfo.exam_status && 0 == orderInfo.ensure_status">
                            <button class="btn btn-primary" @click="ensureOrder(orderInfo.id)"></i> 确认</button>
                        </div>

                    </div>
                </div>
            </div>
            </div>
            <div class="modal-footer">
                <button type="button" class="btn btn-white" data-dismiss="modal">关闭</button>
            </div>
        </div>
    </div>
</div>

<div class="modal inmodal fade" id="rejectHistoryModal" tabindex="-1" role="dialog" aria-hidden="true">
    <div class="modal-dialog modal-lg">
        <div class="modal-content">
            <div class="modal-header">
                <button type="button" class="close" data-dismiss="modal"><span aria-hidden="true">&times;</span><span class="sr-only">Close</span>
                </button>
                <h4 class="modal-title">驳回历史</h4>
                <small class="font-bold"></small>
            </div>
            <div class="modal-body">
                <div class="row">
                    <div class="col-sm-12">
                        <div class="ibox">
                            <div class="ibox-content">
                                <ul class="sortable-list connectList agile-list">
                                    <template v-for="(message, index) in messageList">
                                    <li class="danger-element">
                                        {{message.content}}
                                        <div class="agile-detail">
                                            <i class="fa fa-clock-o"></i> {{message.created_at}}
                                        </div>
                                    </li>
                                    </template>
                                </ul>
                            </div>
                        </div>
                    </div>
                </div>
            </div>
            <div class="modal-footer">
                <button type="button" class="btn btn-white" data-dismiss="modal">关闭</button>
            </div>
        </div>
    </div>
</div>

<script src="/Public/client/static/jquery/2.1.4/jquery.min.js"></script>
<script src="/Public/client/static/bootstrap/3.3.6/js/bootstrap.min.js"></script>
<script src="/Public/client/static/bootstrap-table/1.11.1/bootstrap-table.min.js"></script>
<script src="/Public/client/hplus/js/plugins/sweetalert/sweetalert.min.js"></script>
<script src="/Public/client/static/layer/2.1/layer.min.js"></script>
<script src="/Public/client/static/finance/js/fm.selectator.jquery.js"></script>
<script src="/Public/client/hplus/js/plugins/iCheck/icheck.min.js"></script>
<script type="text/javascript" src="__PUBLIC__/vue/2.3.4/vue.min.js"></script>

<script>
    var $example = $('#example'),$details=$("#details"), $shopDetails = $('#shop_details'),
        selections = [];
    var editing_index = -1;
    var editing_row = '';
    var selected_row = '';

    $("#addShopModal").on("show.bs.modal",function () {
        $("#selectator_add_platform_id,#selectator_add_school_id").remove();
        $("#add_platform_id,#add_school_id").selectator({
            labels: {
                search: '搜索关键字'
            },
            showAllOptionsOnFocus: true,
            keepOpen: false,
            useSearch: true
        });
    });
    $("#editShopModal").on("show.bs.modal",function () {
        $("#selectator_edit_platform_id,#selectator_edit_school_id").remove();
        $("#edit_platform_id,#edit_school_id").selectator({
            labels: {
                search: '搜索关键字'
            },
            showAllOptionsOnFocus: true,
            keepOpen: false,
            useSearch: true
        });
    });

    function initTable() {
        $example.bootstrapTable({
            method: "get",  //使用get请求到服务器获取数据
            url: "/Order/getList", //获取数据的Servlet地址
            striped: true,  //表格显示条纹
            pageSize: 10,  //每页显示的记录数
            pageNumber: 1, //当前第几页
            pageList: [5, 10, 20, 25],  //记录数可选列表
            search: false,  //是否启用查询
            showColumns: false,  //显示下拉框勾选要显示的列
            showRefresh: true,  //显示刷新按钮
            sidePagination: "server", //表示服务端请求
            pagination: true, //启动分页
            dataType: 'json',
            sortOrder: 'desc',
            showExport: false,
            //设置为undefined可以获取pageNumber，pageSize，searchText，sortName，sortOrder
            //设置为limit可以获取limit, offset, search, sort, order
            queryParamsType: "limit",
            queryParams: function queryParams(params) {   //设置查询参数
                var temp_params = dataQueryParams(params);
//                temp_params.user_id = id;
                return temp_params
            },
            responseHandler: function responseHandler(res) {
                var result = {
                    rows: res.data,
                    total: res.total
                };
                return result;
            },
            columns: [
                {
                    title: '订单号',
                    field: 'order_num',
                    rowspan: 1,
                    align: 'center',
                    valign: 'middle',
//                    searchable: true,
//                    sortable: true,
                    visible: true
                },
                {
                    title: '收货公司',
                    field: 'receive_company',
                    rowspan: 1,
                    align: 'center',
                    valign: 'middle',
//                    searchable: true,
//                    sortable: true,
                    visible: true
                },
                {
                    title: '下单时间',
                    field: 'add_time',
                    rowspan: 1,
                    align: 'center',
                    valign: 'middle',
                    visible: true,
                    sortable: false,
                },
                {
                    title: '状态',
                    field: 'status_str',
                    rowspan: 1,
                    align: 'center',
                    valign: 'middle',
                    visible: true,
                    sortable: false
                },
                {
                    title: '操作',
                    rowspan: 1,
                    align: 'center',
                    valign: 'middle',
                    visible: true,
                    sortable: false,
                    events: operateEvents,
                    formatter: operateFormatter
                }
            ]
        });

        setTimeout(function () {
            $example.bootstrapTable('resetView');
        }, 200);
        $example.on('check.bs.table uncheck.bs.table ' +
            'check-all.bs.table uncheck-all.bs.table', function () {

            selections = getIdSelections();

        });
        $example.on('expand-row.bs.table', function (e, index, row, $detail) {

        });
        $example.on('all.bs.table', function (e, name, args) {

        });
    }

    function dataQueryParams(params) {
        return {
            limit: params.limit,
            order: params.order,
            page: params.offset,
            keywords: params.search
        }
    }

    /*formatters*/

    function operateFormatter(value, row) {
        var operate = [
        ];
        operate.push('<a class="detail" href="javascript:void(0)" title="详情">详情</a>&nbsp;');
        if( 0 == row.client_status ) {
            // operate.push('<a class="submit" href="javascript:void(0)" title="提交">提交</a>&nbsp;');
            operate.push('<a class="edit" href="javascript:void(0)" title="编辑">编辑</a>&nbsp;');
            operate.push('<a class="remove" href="javascript:void(0)" title="删除">删除</a>&nbsp;');
            if( 1 == row.is_rejected ) {
                operate.push('<a class="reject" href="javascript:void(0)" title="驳回日志">驳回日志</a>&nbsp;');
            }
        }
        if( 1 == row.exam_status && 0 == row.ensure_status ) {
            // operate.push('<a class="confirm" href="javascript:void(0)" title="待确认">待确认</a>&nbsp;');
        }
        if( 1 == row.express_status ) {
            operate.push('<a class="trace" href="javascript:void(0)" title="跟踪">跟踪</a>&nbsp;');
            operate.push('<a class="transfer" href="javascript:void(0)" title="交接清单">交接清单</a>&nbsp;');
            operate.push('<a class="packing" href="javascript:void(0)" title="装箱单">装箱单</a>&nbsp;');
            operate.push('<a class="invoice" href="javascript:void(0)" title="商业发票">商业发票</a>&nbsp;');
        }
        if( "" != row.operate_remark ) {
            operate.push('<a class="remark" href="javascript:void(0)" title="处理备注">处理备注</a>&nbsp;');
        }
        return operate.join('');
    }
    /*formatters*/

    /*operate events*/
    window.operateEvents = {
        'click .detail': function (e, value, row, index) {
            orderDetail.getOrderInfo(row.id);
        },
        'click .submit': function (e, value, row, index) {
            orderDetail.commitOrder(row.id);
        },
        'click .edit': function (e, value, row, index) {
            if( window.parent !== window ) {
                window.parent.createNewTab("/Order/edit/id/" + row.id + ".html", "编辑订单");
            } else {
                window.location.href = "/Order/edit/id/" + row.id + ".html";
            }
        },
        'click .remove': function (e, value, row, index) {
            var title = "确定删除订单吗";
            var text = "";

            swal({
                title: title,
                text: text,
                type: "info",
                confirmButtonText: "确定",
                cancelButtonText: "取消",
                showCancelButton: true,
                closeOnConfirm: false,
                closeOnCancel: true,
            }, function (confirm) {
                if (confirm) {
                    var url = '/Order/delete';
                    var param = {id:row.id};
                    $.post(url, param, function(response) {
                        if( 1 == response.code ) {
                            swal({
                                title: "",
                                text: response.msg,
                                type: "success",
                            }, function (confirm) {
                                $example.bootstrapTable("refresh");
                            });
                        } else {
                            swal({
                                title: "",
                                text: response.msg,
                                type: "error",
                            });
                        }
                    }, 'json');
                }
            });
        },
        'click .reject': function (e, value, row, index) {
            var url = '/Order/reject';
            var param = {'id':row.id};
            $.post(url, param, function(response) {
                rejectHistory.messageList = response.data;
                $("#rejectHistoryModal").modal();
            }, 'json');
        },
        'click .confirm': function (e, value, row, index) {

        },
        'click .transfer': function (e, value, row, index) {
            window.open("/Order/transfer/id/" + row.id);
        },
        'click .packing': function (e, value, row, index) {
            window.open("/Order/packing/id/" + row.id);
        },
        'click .invoice': function (e, value, row, index) {
            window.open("/Order/invoice/id/" + row.id);
        },

    };

    /*operate events*/
    $(function () {
        var scripts = [
                '/Public/client/static/bootstrap/js/bootstrap-table.js',
                '/Public/client/static/bootstrap/js/bootstrap-table-export.js',
                '/Public/client/static/bootstrap/js/tableExport.js',
                '/Public/client/static/bootstrap/js/bootstrap-table-editable.min.js',
                '/Public/client/static/bootstrap/js/bootstrap-editable.js'
            ],
            eachSeries = function (arr, iterator, callback) {
                callback = callback || function () {
                };
                if (!arr.length) {
                    return callback();
                }
                var completed = 0;
                var iterate = function () {
                    iterator(arr[completed], function (err) {
                        if (err) {
                            callback(err);
                            callback = function () {
                            };
                        }
                        else {
                            completed += 1;
                            if (completed >= arr.length) {
                                callback(null);
                            }
                            else {
                                iterate();
                            }
                        }
                    });
                };
                iterate();
            };
        eachSeries(scripts, getScript, initTable);
    });

    function getScript(url, callback) {
        var head = document.getElementsByTagName('head')[0];
        var script = document.createElement('script');
        script.src = url;

        var done = false;
        // Attach handlers for all browsers
        script.onload = script.onreadystatechange = function () {
            if (!done && (!this.readyState ||
                this.readyState == 'loaded' || this.readyState == 'complete')) {
                done = true;
                if (callback)
                    callback();
                // Handle memory leak in IE
                script.onload = script.onreadystatechange = null;
            }
        };
        head.appendChild(script);
        // We handle everything using the script element injection
        return undefined;
    }


    function show_agreement() {

        tips = layer.open({
            type: 2,
            title: false,
            skin: 'layui-layer-rim', //加上边框
            area: ['900px', '700px'], //宽高,
            shadeClose: true,
            content: '/pdf.pdf'
        });
    }

</script>
<script>
    $(document).ready(function () {
        $(".i-checks").iCheck({checkboxClass: "icheckbox_square-green", radioClass: "iradio_square-green",})
    });

</script>
<script>
    var orderDetail = new Vue({
        el: "#orderDetailModal",
        data: {
            orderInfo: {},  //订单信息
            productList: [],
            specificationList: [],
            orderFee: {},
            billingWeight: "",
            orderFeeMap: {
                delivery_fee: "运费",
                fuel_cost: "燃油费",
                customs_charges: "报关费",
                pick_up_charge: "提货费",
                express_fee: "快递费",
                insurance_premium: "保险费",
                packing_charges: "包装费",
                inspection_fee: "验货费",
                remote_fee: "偏远费",
                over_weight_fee: "超重费",
                over_length_fee: "超长费",
                storage_fee: "储存费",
                incidental: "杂费",
                other_fee: "其他费用",
                // total_fee: "总费用",
                // settlement_method: "结算",
            },
            totalFee: 0,
            settlementMethod: "",
            signature: "",
        },
        mounted: function() {

        },
        methods: {
            getOrderInfo: function(order_id) {
                var that = this;
                var url = "/Order/getOrder";
                var param = {
                    id: order_id
                };
                $.post(url, param, function(response) {
                    if( 1 == response.code ) {
                        that.orderInfo = response.data.order_info;
                        that.orderInfo.enable_spare = parseInt(that.orderInfo.enable_spare);
                        that.productList = response.data.product_list;
                        that.specificationList = response.data.specification_list;
                        that.initOrderFee(response.data.order_fee);
                        if( response.data.order_fee ) {
                            that.totalFee = response.data.order_fee.total_fee;
                            that.settlementMethod = response.data.order_fee.settlement_method;
                        }
                        that.signature = "";
                        that.calBillingWeight();
                    }
                    $("#orderDetailModal").modal();
                }, "json");
            },
            refreshTraceInfo: function(order_id) {

            },
            commitOrder: function(order_id) {
                var that = this;

                var title = "确定提交订单？";
                var text = "（订单提交之后进入待审核状态，无法编辑）";

                swal({
                    title: title,
                    text: text,
                    type: "info",
                    confirmButtonText: "确定",
                    cancelButtonText: "取消",
                    showCancelButton: true,
                    closeOnConfirm: false,
                    closeOnCancel: true,
                }, function (confirm) {
                    if (confirm) {
                        var url = '/Order/commit';
                        var param = {id:order_id};
                        $.post(url, param, function(response) {
                            if( 1 == response.code ) {
                                swal({
                                    title: "",
                                    text: response.msg,
                                    type: "success",
                                }, function (confirm) {
                                    $("#orderDetailModal").modal("hide");
                                   $example.bootstrapTable("refresh");
                                });
                            } else {
                                swal({
                                    title: "",
                                    text: response.msg,
                                    type: "error",
                                });
                            }
                        }, 'json');
                    }
                });
            },

            indexFormatter: function(index) {
                var str = "";
                var start = 0;
                var end = 0;
                for( var i in this.specificationList ) {
                    start = end + 1;
                    end = start + parseInt(this.specificationList[i].count) - 1;
                    if( i == index ) {
                        str = start + "-" + end;
                        break;
                    }
                }
                return str;
            },
            packageTypeFormatter: function(package_type) {
                package_type = parseInt(package_type);
                switch( package_type ) {
                    case 1: return "文件";
                    case 2: return "包裹";
                }
            },
            volumeWeight: function(length, width, height) {
                var temp = length * width * height / 5000;
                temp = temp.toFixed(2);
                return temp;
            },
            calBillingWeight: function() {
                var totalVolumeWeight = 0;
                var totalWeight = 0;

                if( 0 == this.orderInfo.express_status ) {
                    for( var i in this.specificationList ) {
                        totalWeight += this.specificationList[i]["weight"] * this.specificationList[i]["count"];
                        var volumeWeight = this.volumeWeight(this.specificationList[i]["length"], this.specificationList[i]["width"], this.specificationList[i]["height"])
                        totalVolumeWeight += volumeWeight * this.specificationList[i]["count"];
                    }
                } else {
                    for( var i in this.specificationList ) {
                        totalWeight += this.specificationList[i]["real_weight"] * this.specificationList[i]["real_count"];
                        var volumeWeight = this.volumeWeight(this.specificationList[i]["real_length"], this.specificationList[i]["real_width"], this.specificationList[i]["real_height"])
                        totalVolumeWeight += volumeWeight * this.specificationList[i]["real_count"];
                    }
                }


                var result = totalVolumeWeight > totalWeight ? totalVolumeWeight : totalWeight;
                result = result.toFixed(2);
                if( result ) {
                    this.billingWeight = result + "KG";
                } else {
                    this.billingWeight = "";
                }
            },
            initOrderFee: function(order_fee) {
                this.orderFee = [];
                if( order_fee ) {
                    for( var i in order_fee ) {
                        for( var j in this.orderFeeMap ) {
                            if( i == j ) {
                                var temp = {
                                    label: this.orderFeeMap[j],
                                    key: i,
                                    value: order_fee[i],
                                };
                                this.orderFee.push(temp);
                            }
                        }
                        // if( this.orderFee.length > 1 ) {
                        //     break;
                        // }
                    }
                }
            },
            moneyFormatter: function(value) {
                if( !isNaN(parseFloat(value)) ) {
                    return parseFloat(value).toFixed(2);
                } else {
                    return value;
                }
            },
            ensureOrder: function(order_id) {
                var that = this;
                var title = "确定发货吗";
                var text = "";

                if( !($("#agree").is(":checked")) ) {
                    swal({
                        title: "",
                        text: "请同意华度运输协议",
                        type: "error",
                    });
                    return false;
                }

                swal({
                    title: title,
                    text: text,
                    type: "info",
                    confirmButtonText: "确定",
                    cancelButtonText: "取消",
                    showCancelButton: true,
                    closeOnConfirm: false,
                    closeOnCancel: true,
                }, function (confirm) {
                    if (confirm) {
                        var url = '/Order/doEnsure';
                        var param = {
                            id:order_id,
                            autograph: that.signature
                        };

                        $.post(url, param, function(response) {
                            if( 1 == response.code ) {
                                swal({
                                    title: "",
                                    text: response.msg,
                                    type: "success",
                                }, function (confirm) {
                                    $example.bootstrapTable("refresh");
                                    $("#orderDetailModal").modal("hide");
                                });
                            } else {
                                swal({
                                    title: "",
                                    text: response.msg,
                                    type: "error",
                                });
                            }
                        }, 'json');
                    }
                });
            }
        }
    });

    var rejectHistory = new Vue({
        "el": "#rejectHistoryModal",
        data: {
            messageList: [],
        },
        mounted: function() {

        },
        methods: {}
    });
</script>
<script>

</script>

</body>
</html>
